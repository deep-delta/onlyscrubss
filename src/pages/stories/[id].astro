---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Story Details</title>
    <style is:global>
      /* GLOBAL RESET */
      body { margin: 0; background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: #1f2937; padding-bottom: 60px; }
      * { box-sizing: border-box; }

      /* NAV */
      nav { background: white; border-bottom: 1px solid #e5e7eb; padding: 15px 20px; position: sticky; top: 0; z-index: 100; }
      .back-link { text-decoration: none; color: #6b7280; font-weight: 600; font-size: 0.9rem; }
      
      main { max-width: 600px; margin: 30px auto; padding: 0 20px; }

      /* CARD */
      .card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; margin-bottom: 30px; }
      
      .meta-top { display: flex; justify-content: space-between; margin-bottom: 12px; }
      .role-badge { background: #eff6ff; color: #1d4ed8; font-weight: 700; padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; }
      .date { color: #9ca3af; font-size: 0.9rem; }

      .title { font-size: 1.5rem; font-weight: 800; color: #111827; margin: 0 0 16px 0; line-height: 1.2; }
      .body-text { font-size: 1.05rem; line-height: 1.7; color: #374151; white-space: pre-wrap; margin-bottom: 24px; }

      /* MEDIA BUTTON */
      .media-btn {
        display: block; width: 100%; text-align: center;
        background: #f3f4f6; color: #374151; padding: 12px;
        border-radius: 8px; text-decoration: none; font-weight: 600;
        border: 1px solid #d1d5db; margin-top: 20px;
      }
      .media-btn:hover { background: #e5e7eb; }

      /* COMMENTS */
      .comments-header { font-size: 1.1rem; font-weight: 800; margin-bottom: 20px; color: #111827; }
      .comment-list { display: flex; flex-direction: column; gap: 16px; margin-bottom: 40px; }
      .comment { background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb; }
      .c-author { font-weight: 700; font-size: 0.9rem; display: block; margin-bottom: 4px; color: #111827; }
      .c-text { font-size: 0.95rem; color: #4b5563; line-height: 1.5; }

      /* REPLY BOX */
      .reply-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; }
      .input-text { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 1rem; margin-bottom: 10px; background: white; }
      .btn-primary { background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; }
    </style>
  </head>
  <body>
    <nav><a href="/stories" class="back-link">‚Üê Back to Feed</a></nav>
    <main id="content">
      <div style="text-align:center; padding:40px; color:#9ca3af">Loading story...</div>
    </main>

    <script>
      const id = location.pathname.split("/").pop();
      const content = document.getElementById("content");

      function timeAgo(date) { return new Date(date).toLocaleDateString(); }

      async function loadStory() {
        try {
          const res = await fetch(`/api/stories?id=${id}`);
          if(!res.ok) throw new Error();
          const s = await res.json();
          
          const comments = (s.comments || []).map(c => `
            <div class="comment">
              <span class="c-author">${c.author}</span>
              <div class="c-text">${c.text}</div>
            </div>
          `).join("");

          content.innerHTML = `
            <div class="card">
              <div class="meta-top">
                <span class="role-badge">${s.role || 'Anonymous'}</span>
                <span class="date">${timeAgo(s.createdAt)}</span>
              </div>
              <h1 class="title">${s.title || 'Untitled'}</h1>
              <div class="body-text">${s.text}</div>

              ${s.mediaUrl ? `
                <a href="${s.mediaUrl}" target="_blank" class="media-btn">
                  üì∑ View Attached Media
                </a>
              ` : ''}
            </div>

            <div class="comments-header">Comments (${s.comments ? s.comments.length : 0})</div>
            <div class="comment-list">
              ${comments.length ? comments : '<div style="color:#9ca3af; font-style:italic">No comments yet.</div>'}
            </div>

            <div class="reply-box">
              <form onsubmit="postComment(event)">
                <textarea class="input-text" name="text" rows="3" placeholder="Write a supportive comment..." required></textarea>
                <input class="input-text" name="author" placeholder="Your Name (Optional)">
                <button class="btn-primary">Post Comment</button>
              </form>
            </div>
          `;
        } catch(e) { content.innerHTML = "Story not found."; }
      }

      window.postComment = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector("button");
        btn.innerText = "Posting..."; btn.disabled = true;

        const fd = new FormData(e.target);
        await fetch("/api/stories", {
          method: "POST", headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ action: "comment", id, commentText: fd.get("text"), commentAuthor: fd.get("author") })
        });
        location.reload();
      }
      loadStory();
    </script>
  </body>
</html>
