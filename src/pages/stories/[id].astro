---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Story Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* Reusing Light Theme */
      :root { --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --primary: #2563eb; --border: #e5e7eb; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }

      /* HEADER (Matches Feed) */
      nav { background: white; border-bottom: 1px solid var(--border); padding: 0 20px; height: 64px; display: flex; justify-content: center; position: sticky; top: 0; z-index: 50; }
      .nav-container { width: 100%; max-width: 900px; display: flex; justify-content: space-between; align-items: center; }
      .logo { display: flex; align-items: center; gap: 8px; text-decoration: none; color: #1e3a8a; font-weight: 800; font-size: 1.2rem; }
      .back-link { text-decoration: none; color: #6b7280; font-weight: 500; font-size: 0.9rem; }
      .back-link:hover { color: var(--primary); }

      /* MAIN CONTAINER */
      main { max-width: 700px; margin: 30px auto; padding: 0 20px; }

      /* DETAIL CARD */
      .detail-card {
        background: var(--card); border-radius: 20px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        padding: 30px; border: 1px solid var(--border);
        margin-bottom: 40px;
      }

      .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
      .author { font-weight: 700; font-size: 1.1rem; }
      .date { color: #9ca3af; font-size: 0.9rem; }
      .pill { background: #eff6ff; color: var(--primary); padding: 4px 12px; border-radius: 99px; font-size: 0.8rem; font-weight: 600; }

      .story-body { font-size: 1.1rem; line-height: 1.7; color: #374151; white-space: pre-wrap; margin-bottom: 24px; }

      .media-full img, .media-full video { width: 100%; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border); }

      .share-btn {
        background: white; border: 1px solid #d1d5db; color: #374151;
        padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
        display: inline-flex; align-items: center; gap: 8px; width: 100%; justify-content: center;
        transition: background 0.2s;
      }
      .share-btn:hover { background: #f9fafb; border-color: #9ca3af; }

      /* COMMENTS */
      .comments-section { margin-top: 40px; }
      .comments-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
      
      .comment-box {
        background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border);
        display: flex; flex-direction: column; gap: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      }
      .input-field { padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; }
      .input-field:focus { outline: 2px solid var(--primary); border-color: transparent; }
      
      .post-btn {
        background: var(--primary); color: white; border: none; padding: 12px;
        border-radius: 8px; font-weight: 600; cursor: pointer; align-self: flex-end;
      }

      .comment-list { display: flex; flex-direction: column; gap: 16px; margin-top: 30px; padding-bottom: 60px;}
      .comment-item { background: white; padding: 16px; border-radius: 12px; border: 1px solid var(--border); }
      .c-head { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; }
      .c-author { font-weight: 700; }
      .c-time { color: #9ca3af; }
      .c-body { color: #4b5563; line-height: 1.5; }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-container">
        <a href="/stories" class="back-link">‚Üê Back to Feed</a>
        <a href="/" class="logo">
           <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.42 4.83a2 2 0 0 0-1.74-.83H5.32a2 2 0 0 0-1.74.83L2 9h20l-1.58-4.17Z"/><path d="M4 9v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M9 9v11"/><path d="M15 9v11"/><path d="M9 9l-1.5-5"/><path d="M15 9l1.5-5"/></svg>
           Only Scrubs
        </a>
      </div>
    </nav>

    <main id="content">Loading...</main>

    <script>
      const storyId = location.pathname.split("/").pop();
      const content = document.getElementById("content");

      function timeAgo(date) { return new Date(date).toLocaleDateString(); }

      async function loadStory() {
        const headers = localStorage.getItem("adminPassword") ? { "Authorization": `Bearer ${localStorage.getItem("adminPassword")}` } : {};
        try {
          const res = await fetch(`/api/stories?id=${storyId}`, { headers });
          if(!res.ok) throw new Error();
          const story = await res.json();
          render(story);
        } catch(e) { content.innerHTML = "Story not found."; }
      }

      function render(story) {
        const commentsHtml = (story.comments || []).map(c => `
          <div class="comment-item">
            <div class="c-head"><span class="c-author">${c.author}</span><span class="c-time">${timeAgo(c.createdAt)}</span></div>
            <div class="c-body">${c.text}</div>
          </div>`).join("");

        content.innerHTML = `
          <div class="detail-card">
            <div class="header-row">
              <div>
                <div class="author">${story.name}</div>
                <div class="date">${timeAgo(story.createdAt)}</div>
              </div>
              <span class="pill">${story.category || 'General'}</span>
            </div>
            
            <div class="story-body">${story.text}</div>

            ${story.mediaUrl ? `<div class="media-full"><img src="${story.mediaUrl}"></div>` : ''}

            <button class="share-btn" onclick="navigator.clipboard.writeText(location.href); alert('Copied!');">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
              Share Story
            </button>
          </div>

          <div class="comments-section">
            <div class="comments-title">Comments (${story.comments ? story.comments.length : 0})</div>
            
            <form id="cForm" class="comment-box">
              <input name="author" class="input-field" placeholder="Your Name (Optional)">
              <textarea name="text" class="input-field" rows="3" placeholder="Write a supportive comment..." required></textarea>
              <button class="post-btn">Post Comment</button>
            </form>

            <div class="comment-list">${commentsHtml}</div>
          </div>
        `;

        document.getElementById("cForm").onsubmit = async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          await fetch("/api/stories", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ action:"comment", id:storyId, commentText:fd.get("text"), commentAuthor:fd.get("author") })
          });
          location.reload();
        }
      }
      loadStory();
    </script>
  </body>
</html>
