---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #f3f4f6; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .logout { background: #fee2e2; color: #991b1b; border: none; padding: 8px 16px; cursor: pointer; border-radius: 6px; font-weight: bold; }

        .login-overlay { position: fixed; inset: 0; background: #e5e7eb; display: flex; align-items: center; justify-content: center; z-index: 999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 6px; width: 100%; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f9fafb; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
        
        .status { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; }
        .hidden { background: #fee2e2; color: #991b1b; }
        .public { background: #dcfce7; color: #166534; }

        .actions button { margin-right: 6px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .btn-hide { background: #fef3c7; color: #92400e; }
        .btn-del { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div id="login" class="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0">Admin Access</h2>
            <p style="color:#666; margin-bottom:20px">Enter the password from Cloudflare Settings</p>
            <input type="password" id="passInput" placeholder="Password">
            <button class="btn-main" onclick="tryLogin()">Login</button>
            <div id="errorMsg" style="color:red; margin-top:15px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="dashboard" class="container" style="display:none">
        <h1>
            Dashboard
            <button class="logout" onclick="logout()">Logout</button>
        </h1>
        <div id="status" style="color:#666; margin-bottom:10px">Loading...</div>
        <table>
            <thead><tr><th>Status</th><th>Date</th><th>Content</th><th>Actions</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const API = '/api/stories?limit=100';
        
        // Auto-login check
        if(localStorage.getItem("adminPassword")) {
            tryLogin(localStorage.getItem("adminPassword"));
        }

        async function tryLogin(savedPass) {
            const pass = savedPass || document.getElementById("passInput").value;
            const errorDiv = document.getElementById("errorMsg");
            const btn = document.querySelector(".btn-main");
            
            errorDiv.innerText = "";
            btn.innerText = "Checking...";
            
            try {
                const res = await fetch(API, { headers: { "Authorization": `Bearer ${pass}` }});
                
                if (res.status === 401) {
                    throw new Error("Incorrect Password");
                }
                if (res.status === 500) {
                    throw new Error("Server Error (Check Cloudflare Logs)");
                }
                if (!res.ok) {
                    throw new Error(`Error ${res.status}`);
                }

                // Success!
                const data = await res.json();
                localStorage.setItem("adminPassword", pass); // Save it
                document.getElementById("login").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                render(data.stories || []);

            } catch(e) {
                errorDiv.innerText = e.message;
                localStorage.removeItem("adminPassword"); // Clear bad pass
            } finally {
                btn.innerText = "Login";
            }
        }

        function render(stories) {
            const tbody = document.getElementById("tableBody");
            document.getElementById("status").innerText = `${stories.length} stories found.`;
            
            tbody.innerHTML = stories.map(s => `
                <tr>
                    <td><span class="status ${s.hidden ? 'hidden' : 'public'}">${s.hidden ? 'HIDDEN' : 'LIVE'}</span></td>
                    <td>${new Date(s.createdAt).toLocaleDateString()}</td>
                    <td>
                        <strong>${s.title || 'Untitled'}</strong><br>
                        <span style="color:#666; font-size:0.9rem">${s.text.substring(0, 60)}...</span>
                    </td>
                    <td class="actions">
                        <button class="btn-hide" onclick="act('hide', '${s.id}')">${s.hidden ? 'Unhide' : 'Hide'}</button>
                        <button class="btn-del" onclick="act('delete', '${s.id}')">Delete</button>
                    </td>
                </tr>
            `).join("");
        }

        async function act(action, id) {
            if(!confirm("Are you sure?")) return;
            await fetch("/api/stories", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action, id, password: localStorage.getItem("adminPassword") })
            });
            location.reload();
        }

        function logout() {
            localStorage.removeItem("adminPassword");
            location.reload();
        }
    </script>
</body>
</html>
