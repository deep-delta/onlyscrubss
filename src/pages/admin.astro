---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: #f3f4f6; padding: 20px; color: #1f2937; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1 { margin-top: 0; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; font-size: 1.5rem; }
        .logout { background: #fee2e2; color: #991b1b; border: none; padding: 8px 16px; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }

        /* Login Overlay */
        .login-overlay { position: fixed; inset: 0; background: #e5e7eb; display: flex; align-items: center; justify-content: center; z-index: 999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 320px; }
        input { padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 16px 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; font-size: 0.95rem; }
        tr:hover { background: #f9fafb; }

        /* Status Badges */
        .status { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .status.hidden { background: #fee2e2; color: #991b1b; } /* Red */
        .status.public { background: #dcfce7; color: #166534; } /* Green */

        /* Action Buttons */
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-hide { background: #fef3c7; color: #92400e; }
        .btn-del { background: #fee2e2; color: #991b1b; }
        
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <div id="login" class="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:#1f2937">Admin Login</h2>
            <p style="color:#6b7280; margin-bottom:20px; font-size:0.9rem">Enter password from Cloudflare</p>
            <input type="password" id="passInput" placeholder="Password">
            <button class="btn-main" onclick="tryLogin()">Access Dashboard</button>
            <div id="errorMsg" style="color:#ef4444; margin-top:15px; font-weight:bold; font-size:0.9rem"></div>
        </div>
    </div>

    <div id="dashboard" class="container" style="display:none">
        <h1>
            Dashboard
            <button class="logout" onclick="logout()">Logout</button>
        </h1>
        <div id="status" style="color:#6b7280; font-size:0.9rem; margin-bottom:10px">Loading...</div>
        
        <table>
            <thead>
                <tr>
                    <th style="width: 80px;">Status</th>
                    <th style="width: 100px;">Date</th>
                    <th>Story</th>
                    <th style="width: 140px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script is:inline>
        const API_URL = '/api/stories?limit=100';
        
        // Auto-login check
        if(localStorage.getItem("adminPassword")) {
            tryLogin(localStorage.getItem("adminPassword"));
        }

        async function tryLogin(savedPass) {
            const pass = savedPass || document.getElementById("passInput").value;
            const errorDiv = document.getElementById("errorMsg");
            const btn = document.querySelector(".btn-main");
            
            if(errorDiv) errorDiv.innerText = "";
            if(btn) { btn.innerText = "Verifying..."; btn.disabled = true; }
            
            try {
                // 1. Try to fetch data
                const res = await fetch(API_URL, { headers: { "Authorization": `Bearer ${pass}` }});
                
                if (res.status === 401) throw new Error("Incorrect Password");
                if (!res.ok) throw new Error("Server Error: " + res.status);

                const data = await res.json();
                
                // 2. Success - Save & Render
                localStorage.setItem("adminPassword", pass);
                document.getElementById("login").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                render(data.stories || []);

            } catch(e) {
                if(errorDiv) errorDiv.innerText = e.message;
                localStorage.removeItem("adminPassword"); // Clear invalid pass
            } finally {
                if(btn) { btn.innerText = "Access Dashboard"; btn.disabled = false; }
            }
        }

        function render(stories) {
            const tbody = document.getElementById("tableBody");
            document.getElementById("status").innerText = `Showing ${stories.length} stories.`;

            if(stories.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:30px; color:#9ca3af'>No stories found.</td></tr>";
                return;
            }
            
            tbody.innerHTML = stories.map(s => `
                <tr id="row-${s.id}">
                    <td>
                        <span id="badge-${s.id}" class="status ${s.hidden ? 'hidden' : 'public'}">
                            ${s.hidden ? 'HIDDEN' : 'PUBLIC'}
                        </span>
                    </td>
                    <td>${new Date(s.createdAt).toLocaleDateString(undefined, {month:'numeric', day:'numeric'})}</td>
                    <td>
                        <div style="font-weight:700; color:#111827; font-size:0.95rem">${s.title || 'Untitled'}</div>
                        <div style="color:#6b7280; font-size:0.85rem; height: 1.2em; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 250px;">
                            ${s.text}
                        </div>
                    </td>
                    <td class="actions">
                        <button class="btn btn-hide" onclick="toggleHide('${s.id}', ${s.hidden})">
                            ${s.hidden ? 'Unhide' : 'Hide'}
                        </button>
                        <button class="btn btn-del" onclick="deleteStory('${s.id}')">Delete</button>
                    </td>
                </tr>
            `).join("");
        }

        async function toggleHide(id, currentHidden) {
            const row = document.getElementById(`row-${id}`);
            row.style.opacity = "0.5";

            try {
                const res = await fetch("/api/stories", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'hide', id, password: localStorage.getItem("adminPassword") })
                });

                if(!res.ok) throw new Error(await res.text());

                // Optimistic Update
                const badge = document.getElementById(`badge-${id}`);
                const btn = row.querySelector(".btn-hide");
                
                if(currentHidden) {
                    badge.className = "status public"; badge.innerText = "PUBLIC";
                    btn.innerText = "Hide";
                    btn.setAttribute("onclick", `toggleHide('${id}', false)`);
                } else {
                    badge.className = "status hidden"; badge.innerText = "HIDDEN";
                    btn.innerText = "Unhide";
                    btn.setAttribute("onclick", `toggleHide('${id}', true)`);
                }
            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                row.style.opacity = "1";
            }
        }

        async function deleteStory(id) {
            if(!confirm("Permanently delete?")) return;
            
            const row = document.getElementById(`row-${id}`);
            row.style.backgroundColor = "#fee2e2"; // Turn red before disappearing

            try {
                const res = await fetch("/api/stories", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'delete', id, password: localStorage.getItem("adminPassword") })
                });

                if(!res.ok) throw new Error(await res.text());

                row.remove(); // Poof! Gone instantly.

            } catch(e) {
                alert("Error deleting: " + e.message);
                row.style.backgroundColor = "transparent"; // Revert
            }
        }

        function logout() {
            localStorage.removeItem("adminPassword");
            location.reload();
        }
    </script>
</body>
</html>
