---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Only Scrubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <style>
      :root {
        --bg: #f3f4f6;
        --card-bg: #ffffff;
        --text-main: #111827;
        --text-muted: #6b7280;
        --primary: #2563eb; 
        --border: #e5e7eb;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text-main);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      /* --- HEADER & NAV --- */
      nav {
        background: white;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 50;
        padding: 0 20px;
        height: 64px;
        display: flex;
        justify-content: center;
      }

      .nav-container {
        width: 100%;
        max-width: 900px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: var(--primary);
      }
      
      .logo-text { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; color: #1e3a8a; }

      .nav-links { display: flex; gap: 24px; align-items: center; }
      .nav-link { 
        text-decoration: none; color: var(--text-muted); font-weight: 500; font-size: 0.95rem; 
        transition: color 0.2s;
      }
      .nav-link:hover { color: var(--primary); }
      .nav-link.active { color: var(--primary); font-weight: 700; }
      
      .admin-btn {
        background: none; border: none; cursor: pointer;
        color: #9ca3af; font-size: 0.9rem; font-weight: 500;
      }
      .admin-btn:hover { color: #1f2937; }

      /* Mobile Nav Tweaks */
      @media(max-width: 600px) {
        .nav-link { font-size: 0.85rem; }
        .nav-links { gap: 16px; }
      }

      /* --- MAIN LAYOUT --- */
      main {
        max-width: 700px;
        margin: 0 auto;
        padding: 24px 16px 100px;
      }

      /* --- STORY CARD DESIGN --- */
      .story-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        display: flex;
        gap: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.1s;
      }
      .story-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

      .avatar-wrapper { flex-shrink: 0; width: 48px; height: 48px; }
      .avatar-img { width: 100%; height: 100%; border-radius: 50%; background: #f0f9ff; object-fit: cover; border: 1px solid #dbeafe; }

      .content { flex: 1; min-width: 0; }

      .card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
      .user-meta { display: flex; align-items: baseline; gap: 6px; }
      .username { font-weight: 700; font-size: 0.95rem; color: #1f2937; }
      .timestamp { font-size: 0.85rem; color: #9ca3af; }

      .category-pill { font-size: 0.75rem; font-weight: 600; padding: 2px 10px; border-radius: 99px; background: #f3f4f6; color: #4b5563; }

      .story-text { font-size: 1rem; line-height: 1.5; color: #374151; margin-bottom: 12px; white-space: pre-wrap; }

      .media-container img, .media-container video { width: 100%; max-height: 350px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border); }

      .card-actions { display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f9fafb; }
      .action-btn { background: none; border: none; padding: 0; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; }
      .action-btn:hover { color: var(--primary); }

      .fab {
        position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4); transition: transform 0.2s; z-index: 100;
      }
      .fab:hover { transform: scale(1.05); }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-container">
        <a href="/" class="logo-area">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.42 4.83a2 2 0 0 0-1.74-.83H5.32a2 2 0 0 0-1.74.83L2 9h20l-1.58-4.17Z"/><path d="M4 9v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M9 9v11"/><path d="M15 9v11"/><path d="M9 9l-1.5-5"/><path d="M15 9l1.5-5"/></svg>
          <span class="logo-text">Only Scrubs</span>
        </a>

        <div class="nav-links">
          <a href="/" class="nav-link">Home</a>
          <a href="/stories" class="nav-link active">Feed</a>
          <a href="/create" class="nav-link">Share</a>
          <button id="adminToggle" class="admin-btn">Admin</button>
        </div>
      </div>
    </nav>

    <main id="feed">
      <div style="text-align:center; color:#9ca3af; margin-top:40px;">Loading stories...</div>
    </main>

    <a href="/create" class="fab">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </a>

    <script>
      let page = 1;
      let isAdmin = localStorage.getItem("isAdmin") === "true";
      const adminPass = localStorage.getItem("adminPassword");
      const feed = document.getElementById("feed");
      const adminBtn = document.getElementById("adminToggle");

      if(isAdmin) {
        adminBtn.style.color = "#2563eb";
        adminBtn.innerText = "Exit Admin";
      }

      adminBtn.onclick = () => {
        if(isAdmin) {
           if(confirm("Exit admin?")) { localStorage.clear(); location.reload(); }
        } else {
           const p = prompt("Admin Password:");
           if(p) { localStorage.setItem("isAdmin","true"); localStorage.setItem("adminPassword",p); location.reload(); }
        }
      }

      function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if(seconds < 60) return "Just now";
        const m = Math.floor(seconds/60); if(m<60) return `${m}m`;
        const h = Math.floor(m/60); if(h<24) return `${h}h`;
        return new Date(date).toLocaleDateString();
      }

      async function loadStories() {
        const headers = isAdmin ? { "Authorization": `Bearer ${adminPass}` } : {};
        try {
          const res = await fetch(`/api/stories?page=${page}`, { headers });
          const data = await res.json();
          if(page === 1) feed.innerHTML = "";
          
          if(data.stories.length) {
            data.stories.forEach(story => {
              const seed = story.name === "Anonymous" ? story.id : story.name;
              const avatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${seed}&backgroundColor=e2e8f0`;

              const div = document.createElement("div");
              div.className = "story-card";
              div.onclick = (e) => {
                 if(!e.target.closest('button')) window.location.href = `/stories/${story.id}`;
              };

              div.innerHTML = `
                <div class="avatar-wrapper">
                  <img class="avatar-img" src="${avatarUrl}" loading="lazy">
                </div>
                <div class="content">
                  <div class="card-header">
                    <div class="user-meta">
                      <span class="username">${story.name}</span>
                      <span class="timestamp">Â· ${timeAgo(story.createdAt)}</span>
                    </div>
                    <span class="category-pill">${story.category || 'Story'}</span>
                  </div>

                  <div class="story-text">${story.text}</div>

                  ${story.mediaUrl ? `
                    <div class="media-container">
                      ${story.mediaType.startsWith('video') ? 
                        `<video src="${story.mediaUrl}" controls></video>` : 
                        `<img src="${story.mediaUrl}">`}
                    </div>` : ''}

                  <div class="card-actions">
                    <button class="action-btn">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                      ${story.comments ? story.comments.length : 0}
                    </button>
                     ${isAdmin ? '<span style="color:red; font-size:10px">ADMIN</span>' : ''}
                  </div>
                </div>
              `;
              feed.appendChild(div);
            });
          } else {
             feed.innerHTML = "<div style='text-align:center; margin-top:40px'>No stories yet.</div>";
          }
        } catch(e) {
          feed.innerHTML = "Error loading.";
        }
      }
      loadStories();
    </script>
  </body>
</html>
