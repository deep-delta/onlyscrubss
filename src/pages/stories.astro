---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Only Scrubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    
    <style>
      :root {
        --bg: #ffffff; --text: #0f1419; --text-light: #536471;
        --border: #eff3f4; --primary: #1d9bf0; --hover: #f7f9f9;
        
        /* Category Colors */
        --tag-general: #eff3f4; --tag-text-general: #536471;
        --tag-vent: #fff1f2; --tag-text-vent: #be123c;
        --tag-happy: #f0fdf4; --tag-text-happy: #15803d;
        --tag-advice: #eff6ff; --tag-text-advice: #1d4ed8;
        --tag-crazy: #fffbeb; --tag-text-crazy: #b45309;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #000000; --text: #e7e9ea; --text-light: #71767b;
          --border: #2f3336; --primary: #1d9bf0; --hover: #16181c;
          
          --tag-general: #202327; --tag-text-general: #e7e9ea;
          --tag-vent: #4c0519; --tag-text-vent: #fda4af;
          --tag-happy: #052e16; --tag-text-happy: #86efac;
          --tag-advice: #172554; --tag-text-advice: #93c5fd;
          --tag-crazy: #451a03; --tag-text-crazy: #fcd34d;
        }
      }

      body {
        margin: 0; background: var(--bg); color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      nav {
        position: sticky; top: 0; z-index: 50;
        background: rgba(var(--bg), 0.85); backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        display: flex; justify-content: center; align-items: center;
      }
      .logo { font-weight: 800; font-size: 1.1rem; color: var(--text); text-decoration: none; }
      
      main { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

      /* --- FEED ITEM DESIGN --- */
      .story {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex; /* Creates the Row Layout */
        gap: 12px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .story:hover { background: var(--hover); }

      /* The Avatar - Fixed Size */
      .avatar-col {
        flex-shrink: 0; /* Prevents shrinking */
      }
      .avatar {
        width: 44px; height: 44px; 
        border-radius: 50%;
        background: var(--border);
        overflow: hidden;
      }
      .avatar img { width: 100%; height: 100%; object-fit: cover; }

      /* The Content - Takes remaining space */
      .content-col { flex: 1; min-width: 0; }
      
      .header { 
        display: flex; justify-content: space-between; align-items: baseline; 
        margin-bottom: 4px;
      }
      .user-info { font-size: 0.95rem; }
      .name { font-weight: 700; color: var(--text); }
      .time { color: var(--text-light); font-weight: 400; margin-left: 4px; font-size: 0.9rem;}
      
      .category-badge {
        font-size: 0.75rem; font-weight: 600; padding: 2px 8px;
        border-radius: 99px; white-space: nowrap;
      }

      .text {
        font-size: 1rem; line-height: 1.5; color: var(--text);
        margin-top: 2px; margin-bottom: 10px; 
        white-space: pre-wrap; word-wrap: break-word;
      }

      /* Attached Media (Images/Video) */
      .media-box {
        border-radius: 12px; overflow: hidden; border: 1px solid var(--border);
        margin-top: 8px; margin-bottom: 8px;
      }
      .media-box img, .media-box video {
        width: 100%; max-height: 350px; object-fit: cover; display: block;
      }

      /* Action Icons */
      .actions { display: flex; justify-content: space-between; max-width: 80%; margin-top: 8px; }
      .action-item {
        display: flex; align-items: center; gap: 6px;
        color: var(--text-light); font-size: 0.85rem;
        background: none; border: none; padding: 0;
        transition: color 0.2s;
      }
      .action-item svg { width: 18px; height: 18px; }

      /* FAB (Create Button) */
      .fab {
        position: fixed; bottom: 24px; right: 24px;
        width: 56px; height: 56px;
        background: var(--primary); color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 14px rgba(29, 155, 240, 0.4);
        z-index: 100;
      }

      /* Admin Toggle */
      .admin-btn { position: absolute; right: 16px; background: none; border: none; color: var(--text-light); }
    </style>
  </head>
  <body>
    <nav>
      <a href="/" class="logo">Only Scrubs</a>
      <button id="adminToggle" class="admin-btn">
         <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
      </button>
    </nav>

    <main id="feed">
       <div style="padding:40px; text-align:center; color:gray">Loading...</div>
    </main>

    <a href="/create" class="fab">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </a>

    <script>
      let page = 1;
      let isAdmin = localStorage.getItem("isAdmin") === "true";
      const adminPass = localStorage.getItem("adminPassword");
      const feed = document.getElementById("feed");
      const adminToggle = document.getElementById("adminToggle");

      if(isAdmin) adminToggle.style.color = "#1d9bf0";

      adminToggle.onclick = () => {
        if(isAdmin) {
          if(confirm("Logout?")) { localStorage.clear(); location.reload(); }
        } else {
          const p = prompt("Admin Password:");
          if(p) { localStorage.setItem("isAdmin", "true"); localStorage.setItem("adminPassword", p); location.reload(); }
        }
      }

      function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if(seconds < 60) return "Just now";
        const m = Math.floor(seconds/60); if(m<60) return `${m}m`;
        const h = Math.floor(m/60); if(h<24) return `${h}h`;
        return new Date(date).toLocaleDateString();
      }

      function getTagColor(category) {
        const c = category ? category.toLowerCase() : 'general';
        return `background: var(--tag-${c}, var(--tag-general)); color: var(--tag-text-${c}, var(--tag-text-general))`;
      }

      async function loadStories() {
        const headers = isAdmin ? { "Authorization": `Bearer ${adminPass}` } : {};
        try {
          const res = await fetch(`/api/stories?page=${page}`, { headers });
          const data = await res.json();
          
          if(page === 1) feed.innerHTML = "";
          
          if(data.stories.length) {
            data.stories.forEach(story => {
              const seed = story.name === "Anonymous" ? story.id : story.name;
              // Using a reliable avatar style
              const avatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${seed}&backgroundColor=e2e8f0`;

              const div = document.createElement("div");
              div.className = "story";
              div.onclick = (e) => {
                 if(!e.target.closest('button')) window.location.href = `/stories/${story.id}`;
              };

              div.innerHTML = `
                <div class="avatar-col">
                  <div class="avatar"><img src="${avatarUrl}"></div>
                </div>
                <div class="content-col">
                  <div class="header">
                    <div class="user-info">
                      <span class="name">${story.name}</span>
                      <span class="time">Â· ${timeAgo(story.createdAt)}</span>
                    </div>
                    <span class="category-badge" style="${getTagColor(story.category)}">${story.category || 'Story'}</span>
                  </div>
                  
                  <div class="text">${story.text}</div>
                  
                  ${story.mediaUrl ? `
                    <div class="media-box">
                      ${story.mediaType.startsWith('video') ? 
                        `<video src="${story.mediaUrl}" controls></video>` : 
                        `<img src="${story.mediaUrl}" loading="lazy">`}
                    </div>` : ''}

                  <div class="actions">
                    <button class="action-item">
                       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                       ${story.comments ? story.comments.length : 0}
                    </button>
                    ${isAdmin ? '<span style="color:red; font-size:10px">ADMIN MODE</span>' : ''}
                  </div>
                </div>
              `;
              feed.appendChild(div);
            });
          } else {
            feed.innerHTML = "<div style='text-align:center; padding:40px'>No stories yet.</div>";
          }
        } catch(e) {
          feed.innerHTML = "Error loading.";
        }
      }
      loadStories();
    </script>
  </body>
</html>
