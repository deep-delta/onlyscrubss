---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Only Scrubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg: #f3f4f6; --text: #1f2937; --primary: #2563eb; --border: #e5e7eb; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

      /* HEADER */
      nav { background: white; border-bottom: 1px solid #d1d5db; height: 60px; display: flex; justify-content: center; position: sticky; top: 0; z-index: 50; }
      .nav-inner { width: 100%; max-width: 700px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
      .logo { font-weight: 700; color: #111827; text-decoration: none; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;}
      .admin-btn { border: none; background: none; color: #6b7280; font-weight: 500; cursor: pointer; font-size: 0.9rem; }

      main { max-width: 700px; margin: 40px auto; padding: 0 20px 100px; }

      /* LIST CARD DESIGN (Cloudflare Style) */
      .card {
        background: white;
        border: 1px solid #d1d5db; /* Distinct border */
        border-radius: 8px; /* Slight rounding */
        padding: 24px;
        margin-bottom: 24px; /* EXTRA SPACING here */
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: border-color 0.2s, box-shadow 0.2s;
        position: relative;
      }
      .card:hover {
        border-color: #9ca3af;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      }

      /* Numbering Badge */
      .story-number {
        position: absolute;
        top: 24px; left: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        color: #9ca3af;
        font-family: monospace;
      }

      /* Content Layout (Shifted right to make room for number) */
      .card-content { margin-left: 32px; }

      .header-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
      .title { font-size: 1.1rem; font-weight: 700; color: #111827; margin: 0; }
      .meta { font-size: 0.85rem; color: #6b7280; }

      .text { font-size: 1rem; line-height: 1.6; color: #374151; margin-bottom: 16px; white-space: pre-wrap; }

      .footer-row {
        display: flex; gap: 16px; border-top: 1px solid #f3f4f6; padding-top: 12px; margin-top: 16px;
        font-size: 0.85rem; color: #6b7280; font-weight: 600;
      }

      /* Media Preview */
      .media-preview {
        height: 60px; width: 60px; border-radius: 6px; background: #f3f4f6; border: 1px solid #e5e7eb;
        display: flex; align-items: center; justify-content: center; overflow: hidden;
      }
      .media-preview img, .media-preview video { width: 100%; height: 100%; object-fit: cover; }

      /* Floating Create Button */
      .fab {
        position: fixed; bottom: 30px; right: 30px;
        width: 56px; height: 56px;
        background: var(--primary); color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        text-decoration: none; z-index: 100;
        font-size: 24px; padding-bottom: 4px; /* Visual center fix */
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-inner">
        <a href="/" class="logo">Only Scrubs</a>
        <button id="adminBtn" class="admin-btn">Admin</button>
      </div>
    </nav>

    <main id="feed">
      <div style="text-align:center; padding:40px; color:#6b7280">Loading feed...</div>
    </main>

    <a href="/create" class="fab">+</a>

    <script>
      let page = 1;
      let globalIndex = 1; // Counter for numbering
      let isAdmin = localStorage.getItem("isAdmin") === "true";
      const adminPass = localStorage.getItem("adminPassword");
      const feed = document.getElementById("feed");
      const adminBtn = document.getElementById("adminBtn");

      if(isAdmin) { adminBtn.style.color = "#2563eb"; adminBtn.innerText = "Exit Admin"; }

      adminBtn.onclick = () => {
        if(isAdmin) { if(confirm("Logout?")) { localStorage.clear(); location.reload(); } }
        else { const p = prompt("Password:"); if(p){ localStorage.setItem("isAdmin","true"); localStorage.setItem("adminPassword",p); location.reload(); } }
      }

      function timeAgo(date) { return new Date(date).toLocaleDateString(); }

      async function loadStories() {
        const headers = isAdmin ? { "Authorization": `Bearer ${adminPass}` } : {};
        try {
          const res = await fetch(`/api/stories?page=${page}`, { headers });
          const data = await res.json();
          const stories = data.stories || [];
          
          if(page === 1) feed.innerHTML = "";
          if(!stories.length && page === 1) { feed.innerHTML = "<div style='text-align:center'>No stories yet.</div>"; return; }

          stories.forEach(story => {
            const div = document.createElement("div");
            div.className = "card";
            div.onclick = (e) => { 
              if(!e.target.closest('button')) window.location.href = `/stories/${story.id}`; 
            };

            div.innerHTML = `
              <div class="story-number">#${globalIndex++}</div>
              
              <div class="card-content">
                <div class="header-row">
                  <div class="title">${story.title || 'Untitled'}</div>
                  <div class="meta">${timeAgo(story.createdAt)}</div>
                </div>

                <div class="text">${story.text}</div>

                ${story.mediaUrl ? `
                   <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                      <div class="media-preview">
                        ${story.mediaType.startsWith('video') ? '<video src="'+story.mediaUrl+'"></video>' : '<img src="'+story.mediaUrl+'">'}
                      </div>
                      <span style="font-size:0.8rem; color:#6b7280;">Attached Media</span>
                   </div>
                ` : ''}

                <div class="footer-row">
                   <span>ðŸ’¬ ${story.comments ? story.comments.length : 0} Comments</span>
                   <span>By ${story.name}</span>
                   ${isAdmin ? `<button onclick="del(event, '${story.id}')" style="color:red; border:none; background:none; cursor:pointer; margin-left:auto;">Delete</button>` : ''}
                </div>
              </div>
            `;
            feed.appendChild(div);
          });
        } catch(e) { feed.innerHTML = "Error loading."; }
      }

      window.del = async (e, id) => {
        e.stopPropagation();
        if(confirm("Delete?")) {
           await fetch("/api/stories", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:'delete', id, password:adminPass})});
           location.reload();
        }
      }
      loadStories();
    </script>
  </body>
</html>
