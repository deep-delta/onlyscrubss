---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Only Scrubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <style>
      :root {
        --bg: #f0f2f5; /* Facebook light gray */
        --card: #ffffff;
        --text: #050505;
        --text-meta: #65676b;
        --primary: #1b74e4; 
        --border: #ced0d4;
      }

      body {
        margin: 0; background: var(--bg); color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      /* NAV */
      nav {
        background: white; border-bottom: 1px solid var(--border);
        position: sticky; top: 0; z-index: 50; padding: 0 16px; height: 60px;
        display: flex; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .nav-inner { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; }
      .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); text-decoration: none; }
      
      .nav-links a { text-decoration: none; color: var(--text-meta); font-weight: 600; margin-left: 20px; font-size: 0.95rem; }
      .nav-links a.active { color: var(--primary); }

      /* FEED */
      main { max-width: 600px; margin: 20px auto; padding: 0 16px 100px; }

      /* CARD DESIGN (Facebook Style) */
      .card {
        background: white; border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        margin-bottom: 16px; overflow: hidden;
      }

      .card-header {
        padding: 12px 16px; display: flex; align-items: center; gap: 10px;
      }

      /* FORCE AVATAR SIZE */
      .avatar {
        width: 40px !important; height: 40px !important;
        min-width: 40px !important; /* Forces it not to shrink */
        border-radius: 50%; background: #e4e6eb; overflow: hidden;
      }
      .avatar img { width: 100%; height: 100%; object-fit: cover; }

      .user-meta { display: flex; flex-direction: column; line-height: 1.2; }
      .name { font-weight: 600; font-size: 0.95rem; color: var(--text); }
      .meta-row { display: flex; gap: 6px; font-size: 0.8rem; color: var(--text-meta); align-items: center;}
      
      .pill { background: #e4e6eb; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 0.75rem; }

      .card-body {
        padding: 4px 16px 16px;
        font-size: 0.95rem; line-height: 1.5; color: var(--text);
        white-space: pre-wrap;
      }

      .media-box img, .media-box video {
        width: 100%; display: block; max-height: 500px; object-fit: cover;
        border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
      }

      /* ACTIONS FOOTER */
      .card-footer {
        padding: 8px 16px; border-top: 1px solid #f0f2f5;
        display: flex; gap: 4px;
      }
      
      .btn-action {
        flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
        background: none; border: none; padding: 8px; border-radius: 4px;
        color: var(--text-meta); font-weight: 600; font-size: 0.9rem; cursor: pointer;
        transition: background 0.2s;
      }
      .btn-action:hover { background: #f0f2f5; }

      /* ADMIN BUTTONS */
      .admin-row {
        background: #fff4f4; padding: 8px 16px; display: flex; gap: 10px;
        border-top: 1px dashed #feb2b2; justify-content: flex-end;
      }
      .btn-admin {
        padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; border: none; cursor: pointer;
      }

      /* FAB */
      .fab {
        position: fixed; bottom: 24px; right: 24px;
        width: 56px; height: 56px; background: var(--primary);
        color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-inner">
        <a href="/" class="logo">Only Scrubs</a>
        <div class="nav-links">
          <a href="/" class="active">Feed</a>
          <button id="adminToggle" style="border:none; background:none; color:#65676b; font-weight:600; cursor:pointer;">Admin</button>
        </div>
      </div>
    </nav>

    <main id="feed">
      <div style="text-align:center; padding:40px; color:#65676b;">Loading...</div>
    </main>

    <a href="/create" class="fab">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </a>

    <script>
      let page = 1;
      let isAdmin = localStorage.getItem("isAdmin") === "true";
      const adminPass = localStorage.getItem("adminPassword");
      const feed = document.getElementById("feed");
      const adminBtn = document.getElementById("adminToggle");

      if(isAdmin) { adminBtn.style.color = "#1b74e4"; adminBtn.innerText = "Exit Admin"; }

      adminBtn.onclick = () => {
        if(isAdmin) { if(confirm("Exit admin?")) { localStorage.clear(); location.reload(); } }
        else { const p = prompt("Password:"); if(p){ localStorage.setItem("isAdmin","true"); localStorage.setItem("adminPassword",p); location.reload(); } }
      }

      function timeAgo(date) {
        const s = Math.floor((new Date() - new Date(date)) / 1000);
        if(s<60) return "Just now";
        const m = Math.floor(s/60); if(m<60) return `${m}m`;
        const h = Math.floor(m/60); if(h<24) return `${h}h`;
        return new Date(date).toLocaleDateString(); 
      }

      async function loadStories() {
        const headers = isAdmin ? { "Authorization": `Bearer ${adminPass}` } : {};
        try {
          const res = await fetch(`/api/stories?page=${page}`, { headers });
          const data = await res.json();
          if(page === 1) feed.innerHTML = "";
          
          if(data.stories.length) {
            data.stories.forEach(story => {
              const seed = story.name === "Anonymous" ? story.id : story.name;
              const avatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${seed}&backgroundColor=e4e6eb`;

              const div = document.createElement("div");
              div.className = "card";
              
              // Click to view thread
              div.onclick = (e) => {
                 if(!e.target.closest('button')) window.location.href = `/stories/${story.id}`;
              };

              div.innerHTML = `
                <div class="card-header">
                  <div class="avatar">
                    <img src="${avatarUrl}" loading="lazy">
                  </div>
                  <div class="user-meta">
                    <div class="name">${story.name}</div>
                    <div class="meta-row">
                      <span>${timeAgo(story.createdAt)}</span>
                      <span>Â·</span>
                      <span class="pill">${story.category || 'General'}</span>
                    </div>
                  </div>
                </div>

                <div class="card-body">${story.text}</div>

                ${story.mediaUrl ? `
                  <div class="media-box">
                    ${story.mediaType.startsWith('video') ? 
                      `<video src="${story.mediaUrl}" controls></video>` : 
                      `<img src="${story.mediaUrl}">`}
                  </div>` : ''}

                <div class="card-footer">
                  <button class="btn-action">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                    ${story.comments ? story.comments.length : 0} Comments
                  </button>
                  <button class="btn-action" onclick="event.stopPropagation(); navigator.clipboard.writeText('${window.location.origin}/stories/${story.id}'); alert('Link copied!');">
                    Share
                  </button>
                </div>

                ${isAdmin ? `
                  <div class="admin-row">
                    <button class="btn-admin" style="background:#fef3c7; color:#92400e" onclick="adminAct(event, 'hide', '${story.id}')">${story.hidden ? "Unhide" : "Hide"}</button>
                    <button class="btn-admin" style="background:#fee2e2; color:#991b1b" onclick="adminAct(event, 'delete', '${story.id}')">Delete</button>
                  </div>
                ` : ''}
              `;
              feed.appendChild(div);
            });
          } else {
             feed.innerHTML = "<div style='text-align:center; padding:20px'>No stories yet.</div>";
          }
        } catch(e) { feed.innerHTML = "Error loading."; }
      }

      window.adminAct = async (e, action, id) => {
        e.stopPropagation();
        if(!confirm("Confirm action?")) return;
        await fetch("/api/stories", {
          method: "POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action, id, password: adminPass })
        });
        location.reload();
      }

      loadStories();
    </script>
  </body>
</html>
