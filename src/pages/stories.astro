---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Only Scrubs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg: #f3f4f6; --text: #111827; --primary: #2563eb; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }

      nav { background: white; padding: 0 16px; height: 60px; display: flex; justify-content: center; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #e5e7eb; }
      .nav-inner { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; }
      .logo { font-weight: 800; font-size: 1.2rem; color: #1e3a8a; text-decoration: none; }
      .nav-links a { text-decoration: none; color: #6b7280; font-weight: 600; margin-left: 20px; }
      
      main { max-width: 600px; margin: 20px auto; padding: 0 16px 100px; }

      /* CARD */
      .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; }
      
      /* LAYOUT FIX: FORCE ROW */
      .card-row { display: flex; padding: 16px; gap: 12px; align-items: flex-start; }
      
      /* AVATAR FIX: BACKGROUND IMAGE METHOD */
      .avatar { 
        width: 48px; height: 48px; flex-shrink: 0; 
        border-radius: 50%; background-color: #e5e7eb;
        background-size: cover; background-position: center;
      }

      .content { flex: 1; min-width: 0; }
      
      .meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: #6b7280; margin-bottom: 4px; }
      .author { font-weight: 700; color: #374151; }
      
      /* NEW TITLE STYLING */
      .story-title { font-size: 1.1rem; font-weight: 800; color: #111827; margin: 0 0 6px 0; line-height: 1.3; }
      .story-text { font-size: 0.95rem; line-height: 1.5; color: #4b5563; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

      .media { height: 200px; background: #f9fafb; margin-top: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
      .media img, .media video { width: 100%; height: 100%; object-fit: cover; }

      .actions { padding: 10px 16px; border-top: 1px solid #f3f4f6; display: flex; gap: 16px; font-size: 0.85rem; color: #6b7280; font-weight: 600; }
      
      .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(37,99,235,0.4); text-decoration: none; }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-inner">
        <a href="/" class="logo">Only Scrubs</a>
        <div class="nav-links">
           <a href="/">Feed</a>
           <button id="adminBtn" style="border:none; background:none; color:#6b7280; font-weight:600; cursor:pointer">Admin</button>
        </div>
      </div>
    </nav>

    <main id="feed"><div style="text-align:center; padding:40px">Loading...</div></main>
    <a href="/create" class="fab">+</a>

    <script>
      let isAdmin = localStorage.getItem("isAdmin") === "true";
      const adminPass = localStorage.getItem("adminPassword");
      const feed = document.getElementById("feed");
      const adminBtn = document.getElementById("adminBtn");

      if(isAdmin) adminBtn.style.color = "#2563eb";
      
      adminBtn.onclick = () => {
        if(isAdmin) { if(confirm("Exit?")) { localStorage.clear(); location.reload(); } }
        else { const p = prompt("Password:"); if(p){ localStorage.setItem("isAdmin","true"); localStorage.setItem("adminPassword",p); location.reload(); } }
      }

      function timeAgo(d) { return new Date(d).toLocaleDateString(); }

      async function loadStories() {
        const headers = isAdmin ? { "Authorization": `Bearer ${adminPass}` } : {};
        try {
          const res = await fetch("/api/stories", { headers });
          const data = await res.json();
          const stories = data.stories || [];
          feed.innerHTML = "";

          if(!stories.length) { feed.innerHTML = "<div style='text-align:center'>No stories yet.</div>"; return; }

          stories.forEach(story => {
            const seed = story.name === "Anonymous" ? story.id : story.name;
            // Using BACKGROUND IMAGE to fix size issues
            const avatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${seed}&backgroundColor=e5e7eb`;

            const div = document.createElement("div");
            div.className = "card";
            div.onclick = (e) => { if(!e.target.closest('button')) window.location.href = `/stories/${story.id}`; };

            div.innerHTML = `
              <div class="card-row">
                <div class="avatar" style="background-image: url('${avatarUrl}')"></div>
                <div class="content">
                  <div class="meta">
                    <span class="author">${story.name}</span>
                    <span>${timeAgo(story.createdAt)} Â· ${story.category || 'General'}</span>
                  </div>
                  
                  <div class="story-title">${story.title || 'Untitled Story'}</div>
                  <div class="story-text">${story.text}</div>

                  ${story.mediaUrl ? `
                    <div class="media">
                      ${story.mediaType.startsWith('video') ? `<video src="${story.mediaUrl}"></video>` : `<img src="${story.mediaUrl}">`}
                    </div>` : ''}
                </div>
              </div>
              <div class="actions">
                <span>ðŸ’¬ ${story.comments ? story.comments.length : 0} Comments</span>
                ${isAdmin ? `<button onclick="adminAct(event, 'delete', '${story.id}')" style="color:red; border:none; background:none; cursor:pointer">Delete</button>` : ''}
              </div>
            `;
            feed.appendChild(div);
          });
        } catch(e) { feed.innerHTML = "Error loading."; }
      }

      window.adminAct = async (e, action, id) => {
        e.stopPropagation();
        if(confirm("Confirm?")) {
           await fetch("/api/stories", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action, id, password:adminPass})});
           location.reload();
        }
      }
      loadStories();
    </script>
  </body>
</html>
